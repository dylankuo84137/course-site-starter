{# Language Switcher Component #}
{% set switchLang = currentLang or page.lang or locale.default %}
<div class="language-switcher">
  <button
    id="lang-toggle"
    class="lang-button"
    aria-label="{{ i18n[switchLang].lang.switch_to }}"
    aria-expanded="false"
    title="{{ i18n[switchLang].lang.switch_to }}">
    <svg class="lang-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="2" y1="12" x2="22" y2="12"></line>
      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
    </svg>
    <span class="lang-label">{{ locale.labels[switchLang] }}</span>
    <svg class="lang-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <div id="lang-menu" class="lang-menu" hidden>
    {% for lang in locale.available %}
    {% set langUrl = ('/' + lang + '/') if lang != locale.default else '/' %}
    <a
      href="{{ langUrl | url }}"
      class="lang-option {% if lang == switchLang %}active{% endif %}"
      data-lang="{{ lang }}">
      <span class="lang-code">{{ lang }}</span>
      <span class="lang-name">{{ locale.labels[lang] }}</span>
    </a>
    {% endfor %}
  </div>
</div>

<script>
(function() {
  const toggle = document.getElementById('lang-toggle');
  const menu = document.getElementById('lang-menu');
  const basePath = '{{ "/" | url }}';
  const normBase = basePath.replace(/\/+$/, '');
  const normalizePagePath = function(path) {
    if (!path) {
      return '/';
    }
    let normalized = path;
    if (!normalized.startsWith('/')) {
      normalized = '/' + normalized;
    }
    normalized = normalized.replace(/\/+$/, '');
    return normalized === '' ? '/' : normalized;
  };
  const langSpecificPages = (window.__LANG_SPECIFIC_PAGES__ || []).map(normalizePagePath);

  if (!toggle || !menu) return;

  toggle.addEventListener('click', function(e) {
    e.stopPropagation();
    const isHidden = menu.hasAttribute('hidden');
    if (isHidden) {
      menu.removeAttribute('hidden');
      toggle.setAttribute('aria-expanded', 'true');
    } else {
      menu.setAttribute('hidden', '');
      toggle.setAttribute('aria-expanded', 'false');
    }
  });

  document.addEventListener('click', function() {
    menu.setAttribute('hidden', '');
    toggle.setAttribute('aria-expanded', 'false');
  });

  menu.addEventListener('click', function(e) {
    e.stopPropagation();
  });

  // Save language preference when user clicks a language option
  const langOptions = menu.querySelectorAll('.lang-option');
  langOptions.forEach(function(option) {
    option.addEventListener('click', function(e) {
      const selectedLang = this.getAttribute('data-lang');
      if (selectedLang) {
        try {
          localStorage.setItem('preferredLang', selectedLang);
        } catch (err) {
          // Silently fail if localStorage is unavailable
        }

        // Check if we're on a special page with language-specific versions
        const currentPath = window.location.pathname;
        const normPath = currentPath.replace(/\/+$/, '');

        // Check if on homepage
        const isHomepage = normPath === normBase ||
                          normPath.match(new RegExp('^' + normBase.replace(/\//g, '\\/') + '/(en-US|zh-TW)$'));

        // Normalize path relative to site base (supports subfolder deploys)
        let relativePath = normPath;
        if (normBase && normPath.startsWith(normBase)) {
          relativePath = normPath.substring(normBase.length) || '/';
        } else if (!relativePath) {
          relativePath = '/';
        }
        if (!relativePath.startsWith('/')) {
          relativePath = '/' + relativePath;
        }
        relativePath = relativePath.replace(/\/+$/, '') || '/';

        // Determine if current page has a dedicated localized route
        let canonicalPath = relativePath;
        const englishPrefix = '/en-US';
        if (canonicalPath.startsWith(englishPrefix)) {
          canonicalPath = canonicalPath.substring(englishPrefix.length) || '/';
          if (!canonicalPath.startsWith('/')) {
            canonicalPath = '/' + canonicalPath;
          }
          canonicalPath = canonicalPath.replace(/\/+$/, '') || '/';
        }

        const matchedSpecialPage = langSpecificPages.find(function(page) {
          return page === canonicalPath;
        });

        // For special pages with dedicated language versions, navigate to the correct URL
        if (matchedSpecialPage && !isHomepage) {
          e.preventDefault();
          const pageSuffix = matchedSpecialPage === '/' ? '/' : matchedSpecialPage + '/';
          let targetUrl;
          if (selectedLang === 'en-US') {
            // Navigate to English version
            targetUrl = normBase + '/en-US' + pageSuffix;
          } else {
            // Navigate to Chinese version (default, no language prefix)
            targetUrl = normBase + pageSuffix;
          }
          window.location.href = targetUrl;
          return;
        }

        // For homepage and course pages, reload to apply language
        e.preventDefault();
        window.location.reload();
      }
    });
  });
})();
</script>
