{#
  Course Breadcrumb Component
  Consolidated navigation patterns for course pages
#}

{# Unified Course Header - Breadcrumbs + Course Switcher (sticky at top) #}
{% macro unifiedHeader(course, allCourses, currentPage, currentLang, i18nData) %}
  {% import "macros/i18n.njk" as i18nMacro %}
  {% set lang = currentLang or 'zh-TW' %}
  {% set i18n = i18nData or i18n %}

  {% set courseTitle = i18nMacro.cf(course, 'title', lang) %}

  {# Main sticky navbar with glassmorphism - Breadcrumbs + Course Switcher #}
  <nav class="course-breadcrumb-nav" aria-label="{{ i18n[lang].course.course_navigation }}" data-course-i18n="{{ course.i18n | json }}">
    {# Desktop: Breadcrumbs (left) + Course Switcher (right) #}
    <div class="hidden md:flex items-center justify-between h-16 px-4">
      {# Left side: Breadcrumbs #}
      <div class="flex items-center gap-2 text-sm text-stone-600 flex-shrink-0">
        <a href="{{ '/' | url }}" class="hover:text-stone-900"><span data-i18n="nav.home">{{ i18n[lang].nav.home }}</span></a>
        <span aria-hidden="true">â€º</span>
        <a href="{{ '/courses/' | url }}" class="hover:text-stone-900"><span data-i18n="nav.courses">{{ i18n[lang].nav.courses }}</span></a>
        <span aria-hidden="true">â€º</span>
        <span class="text-stone-900 truncate max-w-[150px] lg:max-w-none" data-i18n-course="title">{{ courseTitle }}</span>
      </div>

      {# Right side: Course Switcher #}
      <div class="course-switcher">
        <label>
          <span data-i18n="course.switch_course">{{ i18n[lang].course.switch_course }}</span>
          <select onchange="if(this.value) location.href=this.value"
                  aria-label="{{ i18n[lang].course.switch_course }}">
            {% for other in allCourses %}
            <option value="{{ courseUrl(other.slug, currentPage) }}"
                    {% if other.slug == course.slug %}selected{% endif %}
                    data-course-switcher-i18n='{{ other.i18n | json }}'>
              {% if other.slug == course.slug %}--{% else %}{{ other.i18n[lang].title }}{% endif %}
            </option>
            {% endfor %}
          </select>
        </label>
      </div>
    </div>

    {# Mobile: Course Switcher only #}
    <div class="md:hidden course-switcher" style="justify-content: center; padding: 0.875rem 1rem;">
      <label>
        <span data-i18n="course.switch_course">{{ i18n[lang].course.switch_course }}</span>
        <select onchange="if(this.value) location.href=this.value"
                aria-label="{{ i18n[lang].course.switch_course }}">
          {% for other in allCourses %}
          <option value="{{ courseUrl(other.slug, currentPage) }}"
                  {% if other.slug == course.slug %}selected{% endif %}
                  data-course-switcher-i18n='{{ other.i18n | json }}'>
            {% if other.slug == course.slug %}--{% else %}{{ other.i18n[lang].title }}{% endif %}
          </option>
          {% endfor %}
        </select>
      </label>
    </div>
  </nav>
{% endmacro %}

{# Action Tabs - to be placed after hero section #}
{% macro actionTabs(course, currentPage, currentLang, i18nData) %}
  {% import "macros/i18n.njk" as i18nMacro %}
  {% set lang = currentLang or 'zh-TW' %}
  {% set i18n = i18nData or i18n %}
  {% set docStory = materialHelpers.getDoc(course, 'story') %}
  {% set docPlayScript = materialHelpers.getDoc(course, 'play_script') %}
  {% set hasPhotos = materialHelpers.hasMaterial(course, 'photos') %}
  {% set hasBlackboard = materialHelpers.hasMaterial(course, 'blackboard') %}
  {% set hasPlayScript = docPlayScript or materialHelpers.hasMaterial(course, 'play_scripts') %}
  {% set hasSyllabus = materialHelpers.hasMaterial(course, 'syllabus') %}
  {% set hasWorksheet = materialHelpers.hasMaterial(course, 'worksheet') %}
  {% set hasWorkbook = materialHelpers.hasMaterial(course, 'workbook_photos') or materialHelpers.hasMaterial(course, 'workbook_pdfs') %}
  {% set hasScripts = materialHelpers.hasMaterial(course, 'scripts_photos') %}
  {% set hasSongs = materialHelpers.hasMaterial(course, 'songs_audio') %}
  {% set hasSheetMusic = materialHelpers.hasMaterial(course, 'sheet_music') %}
  {% set hasVideos = materialHelpers.hasMaterial(course, 'videos') %}

  {# Action tabs bar - appears below hero #}
  <div class="course-nav-wrapper">
    <nav aria-label="{{ i18n[lang].course.course_navigation }}">
      <div class="course-nav-row">
        <div class="course-nav-left">
          {# Course Home tab #}
          <a href="{{ courseUrl(course.slug, 'home') }}"
             class="pill {% if currentPage == 'home' %}active{% else %}highlight{% endif %}"
             {% if currentPage == 'home' %}aria-current="page"{% endif %}>
            <span data-i18n="course.course_home">{{ i18n[lang].course.course_home }}</span>
          </a>

          {# Innovation tab (conditional) #}
          {% set hasInnovation = courseInnovations[course.slug] %}
          {% if hasInnovation or currentPage == 'innovation' %}
          <a href="{{ courseUrl(course.slug, 'innovation') }}"
             class="pill {% if currentPage == 'innovation' %}active{% endif %}"
             {% if currentPage == 'innovation' %}aria-current="page"{% endif %}>
            <span aria-hidden="true">ðŸ’¡</span> <span data-i18n="course.innovation">{{ i18n[lang].course.innovation }}</span>
          </a>
          {% endif %}

          {# Materials dropdown #}
          <div class="course-materials-dropdown">
            <select class="course-materials-select"
                    onchange="if(this.value) location.href=this.value"
                    aria-label="{{ i18n[lang].course.course_materials }}"
                    data-i18n-select="course.course_materials">
        <option value="" {% if currentPage == 'home' or currentPage == 'innovation' %}selected{% endif %}>
          {{ i18n[lang].course.course_materials }}
        </option>

        {% if hasSyllabus or currentPage == 'syllabus' %}
        <option value="{{ courseUrl(course.slug, 'syllabus') }}"
                {% if currentPage == 'syllabus' %}selected{% endif %}>
          {{ i18n[lang].course.syllabus }}
        </option>
        {% endif %}

        {% if hasWorksheet or currentPage == 'worksheet' %}
        <option value="{{ courseUrl(course.slug, 'worksheet') }}"
                {% if currentPage == 'worksheet' %}selected{% endif %}>
          {{ i18n[lang].course.worksheet }}
        </option>
        {% endif %}

        {% if docStory %}
        <option value="{{ courseUrl(course.slug, 'story') }}"
                {% if currentPage == 'story' %}selected{% endif %}>
          {{ i18n[lang].course.story }}
        </option>
        {% endif %}

        {% if hasPlayScript or currentPage == 'play-script' %}
        <option value="{{ courseUrl(course.slug, 'play-script') }}"
                {% if currentPage == 'play-script' %}selected{% endif %}>
          {{ i18n[lang].course.play_script }}
        </option>
        {% endif %}

        {% if hasWorkbook or currentPage == 'workbook' %}
        <option value="{{ courseUrl(course.slug, 'workbook') }}"
                {% if currentPage == 'workbook' %}selected{% endif %}>
          {{ i18n[lang].course.workbook }}
        </option>
        {% endif %}

        {% if hasPhotos %}
        <option value="{{ courseUrl(course.slug, 'photos') }}"
                {% if currentPage == 'photos' %}selected{% endif %}>
          {{ i18n[lang].course.photo_gallery }}
        </option>
        {% endif %}

        {% if hasBlackboard %}
        <option value="{{ courseUrl(course.slug, 'blackboard') }}"
                {% if currentPage == 'blackboard' %}selected{% endif %}>
          {{ i18n[lang].course.blackboard_drawings }}
        </option>
        {% endif %}

        {% if hasScripts or currentPage == 'scripts' %}
        <option value="{{ courseUrl(course.slug, 'scripts') }}"
                {% if currentPage == 'scripts' %}selected{% endif %}>
          {{ i18n[lang].course.performance }}
        </option>
        {% endif %}

        {% if hasSongs or currentPage == 'songs' %}
        <option value="{{ courseUrl(course.slug, 'songs') }}"
                {% if currentPage == 'songs' %}selected{% endif %}>
          {{ i18n[lang].course.songs }}
        </option>
        {% endif %}

        {% if hasSheetMusic %}
        <option value="{{ courseUrl(course.slug, 'sheet-music') }}"
                {% if currentPage == 'sheet-music' %}selected{% endif %}>
          {{ i18n[lang].course.sheet_music }}
        </option>
        {% endif %}

        {% if hasVideos %}
        <option value="{{ courseUrl(course.slug, 'videos') }}"
                {% if currentPage == 'videos' %}selected{% endif %}>
          {{ i18n[lang].course.video }}
        </option>
        {% endif %}
            </select>
          </div>
        </div>
      </div>
    </nav>
  </div>
{% endmacro %}

{# Legacy breadcrumb macro - kept for backward compatibility #}
{% macro breadcrumb(course, allCourses, currentPage, currentLang, i18nData) %}
  {{ unifiedHeader(course, allCourses, currentPage, currentLang, i18nData) }}
  {{ actionTabs(course, currentPage, currentLang, i18nData) }}
{% endmacro %}

{% macro navItem(course, page, currentPage, lang, i18n, label) %}
  <li role="presentation">
    <a href="{{ courseUrl(course.slug, page) }}"
       class="pill {% if currentPage == page %}active{% endif %}"
       {% if currentPage == page %}aria-current="page"{% endif %}
       role="tab">
      {{ label }}
    </a>
  </li>
{% endmacro %}

{% macro courseUrl(courseSlug, page) %}
  {%- if page == 'home' -%}
    {{ ('/courses/' + courseSlug + '/') | url }}
  {%- else -%}
    {{ ('/courses/' + courseSlug + '/' + page + '/') | url }}
  {%- endif -%}
{% endmacro %}

{#
  Simplified breadcrumb for pages that only need basic navigation
  Usage: {{ breadcrumbSimple(course, 'Page Title', currentLang, i18n) }}
#}
{% macro breadcrumbSimple(course, pageTitle, currentLang, i18nData) %}
  {% set lang = currentLang or 'zh-TW' %}
  {% set i18n = i18nData or i18n %}

  <nav aria-label="{{ i18n[lang].course.breadcrumb }}" class="mb-4">
    <ol class="flex items-center space-x-2 text-sm text-stone-600">
      <li>
        <a href="{{ '/' | url }}" class="hover:text-stone-900">{{ i18n[lang].nav.home }}</a>
      </li>
      <li class="before:content-['/'] before:mx-2">
        <a href="{{ '/courses/' | url }}" class="hover:text-stone-900">{{ i18n[lang].nav.courses }}</a>
      </li>
      <li class="before:content-['/'] before:mx-2">
        <a href="{{ courseUrl(course.slug, 'home') }}" class="hover:text-stone-900">{{ course.i18n[lang].title }}</a>
      </li>
      {% if pageTitle %}
      <li class="before:content-['/'] before:mx-2 font-medium text-stone-900" aria-current="page">
        {{ pageTitle }}
      </li>
      {% endif %}
    </ol>
  </nav>
{% endmacro %}

{#
  Header component that combines breadcrumb with course title
  Usage: {{ headerWithNav(course, allCourses, currentPage, pageTitle, currentLang, i18n) }}
#}
{% macro headerWithNav(course, allCourses, currentPage, pageTitle, currentLang, i18nData) %}
  {% set lang = currentLang or 'zh-TW' %}
  {% set i18n = i18nData or i18n %}

  {{ breadcrumb(course, allCourses, currentPage, lang, i18n) }}

  {% if pageTitle %}
  <header class="mb-6">
    <h1 class="text-2xl md:text-3xl font-semibold">{{ pageTitle }}</h1>
    {% if currentPage != 'home' %}
    <p class="text-stone-600 mt-1">
      <span>{{ course.i18n[lang].grade }}</span>ãƒ»
      <span>{{ course.i18n[lang].semester }}</span>ï½œ
      <span>{{ course.i18n[lang].unit }}</span>ï½œ
      <span>{{ course.i18n[lang].domain }}</span>
    </p>
    {% endif %}
  </header>
  {% endif %}
{% endmacro %}
