{#
  Course Breadcrumb Component
  Consolidated navigation patterns for course pages
#}

{# Unified Course Header - Card on top, navigation on bottom #}
{% macro unifiedHeader(course, allCourses, currentPage, currentLang, i18nData) %}
  {% import "macros/i18n.njk" as i18nMacro %}
  {% set lang = currentLang or 'zh-TW' %}
  {% set i18n = i18nData or i18n %}
  {% set docStory = materialHelpers.getDoc(course, 'story') %}
  {% set docPlayScript = materialHelpers.getDoc(course, 'play_script') %}
  {% set hasPhotos = materialHelpers.hasMaterial(course, 'photos') %}
  {% set hasBlackboard = materialHelpers.hasMaterial(course, 'blackboard') %}
  {% set hasPlayScript = docPlayScript or materialHelpers.hasMaterial(course, 'play_scripts') %}
  {% set hasWorkbook = materialHelpers.hasMaterial(course, 'workbook_photos') or materialHelpers.hasMaterial(course, 'workbook_pdfs') %}
  {% set hasScripts = materialHelpers.hasMaterial(course, 'scripts_photos') %}
  {% set hasSongs = materialHelpers.hasMaterial(course, 'songs_audio') %}
  {% set hasSheetMusic = materialHelpers.hasMaterial(course, 'sheet_music') %}
  {% set hasVideos = materialHelpers.hasMaterial(course, 'videos') %}

  {% set courseTitle = i18nMacro.cf(course, 'title', lang) %}
  {% set courseGrade = i18nMacro.cf(course, 'grade', lang) %}
  {% set courseSemester = i18nMacro.cf(course, 'semester', lang) %}
  {% set courseUnit = i18nMacro.cf(course, 'unit', lang) %}
  {% set courseDomain = i18nMacro.cf(course, 'domain', lang) %}
  {% set courseTeacher = i18nMacro.cf(course, 'teacher', lang) %}

  <div class="course-header-block">
    {# Row 1: Info Card (left) and Switcher (right) #}
    <div class="course-header-meta">
      {% set cardClasses = ['course-info-card'] %}
      {% if course.hero_image %}{% set cardClasses = cardClasses.concat(['course-info-card--has-hero']) %}{% endif %}
      <div class="{{ cardClasses | join(' ') }}" data-course-i18n="{{ course.i18n | json }}">
        <div class="course-info-card-inner">
          <div class="course-info-card-content">
            <h2 class="course-info-title" data-i18n-course="title">{{ courseTitle }}</h2>
            <div class="course-info-metadata">
              <span data-i18n-course="grade">{{ courseGrade }}</span>
              <span class="course-info-separator">・</span>
              <span data-i18n-course="semester">{{ courseSemester }}</span>
            </div>
            <div class="course-info-metadata">
              <span data-i18n-course="unit">{{ courseUnit }}</span>
              <span class="course-info-separator">｜</span>
              <span data-i18n-course="domain">{{ courseDomain }}</span>
            </div>
            {% if courseTeacher %}
            <div class="course-info-teacher">
              <span class="course-info-teacher-label" data-i18n="course.teacher">{{ i18n[lang].course.teacher }}</span>:
              <span data-i18n-course="teacher">{{ courseTeacher }}</span>
            </div>
            {% endif %}
          </div>
          {% if course.hero_image %}
          <figure class="course-info-card-media">
            <img
              src="https://drive.google.com/thumbnail?id={{ course.hero_image }}&sz=w1200"
              alt="{{ courseTitle }}"
              loading="lazy"
              decoding="async">
          </figure>
          {% endif %}
        </div>
      </div>

      <div class="course-switcher">
        <label class="text-sm text-stone-600">
          {{ i18n[lang].course.switch_course }}
          <select class="border rounded-md px-2 py-1" onchange="if(this.value) location.href=this.value" aria-label="{{ i18n[lang].course.switch_course }}">
            {% for other in allCourses %}
              <option value="{{ courseUrl(other.slug, currentPage) }}"
                      {% if other.slug == course.slug %}selected{% endif %}
                      data-course-switcher-i18n='{{ other.i18n | json }}'>
                {{ other.i18n[lang].title }}
              </option>
            {% endfor %}
          </select>
        </label>
      </div>
    </div>

    {# Row 2: Navigation Row #}
    <nav aria-label="{{ i18n[lang].course.course_navigation }}">
      <div class="course-nav-row">
        {# Left side: Course Home pill + Materials dropdown #}
        <div class="course-nav-left">
          <a href="{{ courseUrl(course.slug, 'home') }}"
             class="pill {% if currentPage == 'home' %}active{% else %}highlight{% endif %}"
             aria-label="{{ i18n[lang].course.course_home }}">
            {{ i18n[lang].course.course_home }}
          </a>

          <div class="course-materials-dropdown">
            <select class="course-materials-select"
                    onchange="if(this.value) location.href=this.value"
                    aria-label="{{ i18n[lang].course.course_materials }}">
              <option value="" {% if currentPage == 'home' %}selected{% endif %}>
                {{ i18n[lang].course.course_materials }}
              </option>

              {% if docStory %}
              <option value="{{ courseUrl(course.slug, 'story') }}"
                      {% if currentPage == 'story' %}selected{% endif %}>
                {{ i18n[lang].course.story }}
              </option>
              {% endif %}

              {% if hasPlayScript or currentPage == 'play-script' %}
                <option value="{{ courseUrl(course.slug, 'play-script') }}"
                        {% if currentPage == 'play-script' %}selected{% endif %}>
                  {{ i18n[lang].course.play_script }}
                </option>
              {% endif %}

              {% if hasWorkbook or currentPage == 'workbook' %}
                <option value="{{ courseUrl(course.slug, 'workbook') }}"
                        {% if currentPage == 'workbook' %}selected{% endif %}>
                  {{ i18n[lang].course.workbook }}
                </option>
              {% endif %}

              {% if hasPhotos %}
              <option value="{{ courseUrl(course.slug, 'photos') }}"
                      {% if currentPage == 'photos' %}selected{% endif %}>
                {{ i18n[lang].course.photo_gallery }}
              </option>
              {% endif %}

              {% if hasBlackboard %}
              <option value="{{ courseUrl(course.slug, 'blackboard') }}"
                      {% if currentPage == 'blackboard' %}selected{% endif %}>
                {{ i18n[lang].course.blackboard_drawings }}
              </option>
              {% endif %}

              {% if hasScripts or currentPage == 'scripts' %}
                <option value="{{ courseUrl(course.slug, 'scripts') }}"
                        {% if currentPage == 'scripts' %}selected{% endif %}>
                  {{ i18n[lang].course.performance }}
                </option>
              {% endif %}

              {% if hasSongs or currentPage == 'songs' %}
                <option value="{{ courseUrl(course.slug, 'songs') }}"
                        {% if currentPage == 'songs' %}selected{% endif %}>
                  {{ i18n[lang].course.songs }}
                </option>
              {% endif %}

              {% if hasSheetMusic %}
              <option value="{{ courseUrl(course.slug, 'sheet-music') }}"
                      {% if currentPage == 'sheet-music' %}selected{% endif %}>
                {{ i18n[lang].course.sheet_music }}
              </option>
              {% endif %}

              {% if hasVideos %}
              <option value="{{ courseUrl(course.slug, 'videos') }}"
                      {% if currentPage == 'videos' %}selected{% endif %}>
                {{ i18n[lang].course.video }}
              </option>
              {% endif %}
            </select>
          </div>
        </div>
      </div>
    </nav>
  </div>
{% endmacro %}

{# Legacy breadcrumb macro - kept for backward compatibility #}
{% macro breadcrumb(course, allCourses, currentPage, currentLang, i18nData) %}
  {{ unifiedHeader(course, allCourses, currentPage, currentLang, i18nData) }}
{% endmacro %}

{% macro navItem(course, page, currentPage, lang, i18n, label) %}
  <li role="presentation">
    <a href="{{ courseUrl(course.slug, page) }}" 
       class="pill {% if currentPage == page %}active{% endif %}"
       {% if currentPage == page %}aria-current="page"{% endif %}
       role="tab">
      {{ label }}
    </a>
  </li>
{% endmacro %}

{% macro courseUrl(courseSlug, page) %}
  {%- if page == 'home' -%}
    {{ '/courses/' | url }}{{ courseSlug }}/
  {%- else -%}
    {{ '/courses/' | url }}{{ courseSlug }}/{{ page }}/
  {%- endif -%}
{% endmacro %}

{# 
  Simplified breadcrumb for pages that only need basic navigation
  Usage: {{ breadcrumbSimple(course, 'Page Title', currentLang, i18n) }}
#}
{% macro breadcrumbSimple(course, pageTitle, currentLang, i18nData) %}
  {% set lang = currentLang or 'zh-TW' %}
  {% set i18n = i18nData or i18n %}
  
  <nav aria-label="{{ i18n[lang].course.breadcrumb }}" class="mb-4">
    <ol class="flex items-center space-x-2 text-sm text-stone-600">
      <li>
        <a href="{{ '/' | url }}" class="hover:text-stone-900">{{ i18n[lang].nav.home }}</a>
      </li>
      <li class="before:content-['/'] before:mx-2">
        <a href="{{ '/courses/' | url }}" class="hover:text-stone-900">{{ i18n[lang].nav.courses }}</a>
      </li>
      <li class="before:content-['/'] before:mx-2">
        <a href="{{ courseUrl(course.slug, 'home') }}" class="hover:text-stone-900">{{ course.i18n[lang].title }}</a>
      </li>
      {% if pageTitle %}
      <li class="before:content-['/'] before:mx-2 font-medium text-stone-900" aria-current="page">
        {{ pageTitle }}
      </li>
      {% endif %}
    </ol>
  </nav>
{% endmacro %}

{#
  Header component that combines breadcrumb with course title
  Usage: {{ headerWithNav(course, allCourses, currentPage, pageTitle, currentLang, i18n) }}
#}
{% macro headerWithNav(course, allCourses, currentPage, pageTitle, currentLang, i18nData) %}
  {% set lang = currentLang or 'zh-TW' %}
  {% set i18n = i18nData or i18n %}
  
  {{ breadcrumb(course, allCourses, currentPage, lang, i18n) }}
  
  {% if pageTitle %}
  <header class="mb-6">
    <h1 class="text-2xl md:text-3xl font-semibold">{{ pageTitle }}</h1>
    {% if currentPage != 'home' %}
    <p class="text-stone-600 mt-1">
      <span>{{ course.i18n[lang].grade }}</span>・
      <span>{{ course.i18n[lang].semester }}</span>｜
      <span>{{ course.i18n[lang].unit }}</span>｜
      <span>{{ course.i18n[lang].domain }}</span>
    </p>
    {% endif %}
  </header>
  {% endif %}
{% endmacro %}
