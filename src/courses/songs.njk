---
layout: layouts/base.njk
hidePagefindSearch: true
pagination:
  data: coursesList
  size: 1
  alias: c
permalink: "/courses/{{ c.slug }}/songs/index.html"
---
{% import "components/course-breadcrumb.njk" as breadcrumb with context %}

{# Course navigation with home pill highlighted and materials dropdown #}
{{ breadcrumb.breadcrumb(c, coursesList, 'songs', currentLang, i18n) }}


{% set courseSongs = materialHelpers.getMaterialItems(c, 'songs_audio') %}

<h1 class="text-2xl md:text-3xl font-semibold mb-6" style="color: var(--primary);">{{ i18n[currentLang].course.songs_audio }}</h1>

{% if courseSongs and courseSongs.length > 0 %}
<div class="playlist-container">
  <h2 class="playlist-title">æ’­æ”¾åˆ—è¡¨</h2>
  <div class="current-track">
    <div class="current-track-name" id="currentTrackName">é¸æ“‡ä¸€é¦–æ­Œæ›²é–‹å§‹æ’­æ”¾</div>
  </div>
  <div id="playerContainer">
    <audio id="mainPlayer" class="audio-player" controls preload="metadata">
      ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ audio æ’­æ”¾ã€‚
    </audio>
    <iframe id="drivePlayer" class="drive-player" style="display: none;" allowfullscreen></iframe>
  </div>
</div>

<div class="space-y-4">
  {% for s in courseSongs %}
    {% set songTitle = s.title or s.name or ('Track ' ~ loop.index) %}
    <div class="audio-card" data-track-id="{{ loop.index0 }}" data-title="{{ songTitle }}" data-src="https://drive.google.com/uc?export=download&id={{ s.id }}">
      <div class="flex justify-between items-start mb-3">
        <h3 class="audio-title flex-1">{{ songTitle }}</h3>
        <span class="text-sm px-2 py-1 rounded-full" style="background: var(--nature-green-light); color: var(--nature-green);">{{ loop.index }}</span>
      </div>
      <div class="audio-controls">
        <button class="play-btn px-4 py-2 rounded-lg font-medium transition-all hover:opacity-80" style="background: var(--primary); color: var(--warm-cream);" onclick="playTrack({{ loop.index0 }})">
          â–¶ æ’­æ”¾
        </button>
        <a href="https://drive.google.com/uc?export=download&id={{ s.id }}" class="download-link" download>
          ğŸ“¥ ä¸‹è¼‰
        </a>
      </div>
    </div>
  {% endfor %}
</div>

<script>
let currentTrackIndex = 0;
const rawSongs = {{ courseSongs | json | safe }};
const tracks = rawSongs.map((song, index) => ({
  title: song.title || song.name || `Track ${index + 1}`,
  id: song.id,
  src: `https://drive.google.com/uc?export=download&id=${song.id}`,
  streamUrl: `https://docs.google.com/uc?export=download&id=${song.id}`,
  fallbackUrl: `https://drive.google.com/file/d/${song.id}/preview`
}));

async function playTrack(index) {
  const audioPlayer = document.getElementById('mainPlayer');
  const drivePlayer = document.getElementById('drivePlayer');
  const trackName = document.getElementById('currentTrackName');
  const track = tracks[index];
  
  if (!track) return;

  trackName.textContent = track.title;
  currentTrackIndex = index;
  
  // Update UI immediately
  updatePlayButtonsUI();
  const currentBtn = document.querySelector(`[data-track-id="${index}"] .play-btn`);
  if (currentBtn) {
    currentBtn.textContent = 'â³ è¼‰å…¥ä¸­';
    currentBtn.style.background = 'var(--accent)';
  }

  // Try audio first, then fallback to embedded Drive player
  try {
    const audioUrl = `https://drive.google.com/uc?export=download&id=${track.id}`;
    audioPlayer.src = audioUrl;
    await audioPlayer.load();
    await audioPlayer.play();
    
    // Success - show audio player, hide iframe
    audioPlayer.style.display = 'block';
    drivePlayer.style.display = 'none';
    
    if (currentBtn) {
      currentBtn.textContent = 'â¸ æ’­æ”¾ä¸­';
      currentBtn.style.background = 'var(--accent)';
    }
    
    console.log(`Successfully playing: ${track.title} via audio element`);
    
  } catch (error) {
    console.log(`Audio playback failed for ${track.title}, using embedded player`);
    
    // Use embedded Google Drive player
    const embedUrl = `https://drive.google.com/file/d/${track.id}/preview`;
    drivePlayer.src = embedUrl;
    
    // Show iframe, hide audio player
    audioPlayer.style.display = 'none';
    drivePlayer.style.display = 'block';
    
    if (currentBtn) {
      currentBtn.textContent = 'ğŸµ æ’­æ”¾ä¸­ (å…§åµŒ)';
      currentBtn.style.background = 'var(--accent)';
    }
  }
}

function updatePlayButtonsUI() {
  document.querySelectorAll('.play-btn').forEach(btn => {
    btn.textContent = 'â–¶ æ’­æ”¾';
    btn.style.background = 'var(--primary)';
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const audioPlayer = document.getElementById('mainPlayer');
  const drivePlayer = document.getElementById('drivePlayer');
  
  audioPlayer.addEventListener('ended', function() {
    if (tracks.length) {
      const nextIndex = (currentTrackIndex + 1) % tracks.length;
      playTrack(nextIndex);
    }
  });
  
  audioPlayer.addEventListener('pause', function() {
    updatePlayButtonsUI();
  });
});
</script>

{% else %}
<div class="text-center py-12">
  <p style="color: var(--text-muted);" class="text-lg">
    å°šæœªæŠ“åˆ°éŸ³æª”ã€‚
    <span class="block text-sm mt-2 text-stone-400">è«‹åœ¨ <code>material.songs_audio</code> ä¸­è¨­å®šéŸ³è¨Šè³‡æ–™å¤¾æˆ–æ‰‹å‹•æ¸…å–®ã€‚</span>
  </p>
</div>
{% endif %}
